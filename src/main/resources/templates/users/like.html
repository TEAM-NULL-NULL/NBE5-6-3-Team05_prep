<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<style>
  .pagination ul {
    list-style: none;
    display: flex;
    gap: 5px;
    padding-left: 0;
  }

  .pagination li {
    display: inline;
  }

  .pagination a {
    padding: 6px 12px;
    border: 1px solid #ccc;
    color: black;
    text-decoration: none;
    border-radius: 4px;
  }

  .pagination li.active a {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  .like-item {
    display: none;
    margin-top: 20px;
  }


</style>
<body>
<div layout:fragment="content">
  <h3>좋아요 목록</h3>

  <!-- 탭 버튼 -->
  <div class="header-buttons">
  <div>
    <button class="mypage-btn" onclick="location.href='/users/like?tab=books'">도서</button>
    <button class="mypage-btn" onclick="location.href='/users/like?tab=movies'">영화</button>
    <button class="mypage-btn" onclick="location.href='/users/like?tab=musics'">음악</button>
  </div>
</div>
  <!-- 도서 탭 -->
  <div id="books" class="like-item" th:if="${activeTab == 'books'}">
    <h2>도서</h2>
    <table>
      <thead>
      <tr>
        <th>좋아요</th><th>제목</th><th>ISBN</th><th>이미지</th><th>저자</th><th>출판사</th><th>출판일</th><th>장르</th><th>설명</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="book : ${likedbooks.content()}">
       <td> <button class="toggle-star-btn"
                th:id="'toggle-book-' + ${book.title}"
                th:attr="data-type='book', data-id=${book.isbn}"
                onclick="toggle(this)">
          ★
        </button> </td>
        <td th:text="${book.title}"></td>
        <td th:text="${book.isbn}"></td>
        <td><img th:src="${book.image}" width="100"></td>
        <td th:text="${book.author}"></td>
        <td th:text="${book.publisher}"></td>
        <td th:text="${book.publishedDate}"></td>
        <td th:text="${book.genre}"></td>
        <td th:text="${book.description}"></td>
      </tr>
      </tbody>
    </table>

    <!-- 도서 페이지네이션 -->
    <div id="books-pagination" class="pagination" th:if="${likedbooks.page.totalPages > 1}">
      <ul>
        <!-- 이전 페이지 링크: 1보다 클 때만 표시 -->
        <li th:if="${likedbooks.currentNumber() > 1}">
          <a href="#" th:attr="data-page=${likedbooks.currentNumber() - 2}, data-tab='books'">«</a>
        </li>

        <!-- 페이지 번호 렌더링 -->
        <li th:each="i : ${#numbers.sequence(likedbooks.startNumber(), likedbooks.endNumber())}"
            th:classappend="${i == likedbooks.currentNumber} ? 'active'">
          <a href="#"
             th:attr="data-page=${i - 1}, data-tab='books'"
             th:text="${i}"></a>
        </li>

        <!-- 다음 페이지 링크: 현재 페이지가 마지막 페이지보다 작을 때만 표시 -->
        <li th:if="${likedbooks.currentNumber < likedbooks.page.totalPages}">
          <a href="#" th:attr="data-page=${likedbooks.currentNumber}, data-tab='books'">»</a>
        </li>
      </ul>
    </div>

  </div>

  <!-- 영화 탭 -->
  <div id="movies" class="like-item" th:if="${activeTab == 'movies'}">
    <h2>영화</h2>
    <table>
      <thead>
      <tr>
        <th>좋아요</th><th>제목</th><th>썸네일</th><th>설명</th><th>장르</th><th>개봉일</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="movie : ${likedmovies.content()}">
        <td> <button class="toggle-star-btn"
                     th:id="'toggle-movie-' + ${movie.title}"
                     th:attr="data-type='movie', data-id=${movie.id}"
                     onclick="toggle(this)">
          ★
        </button> </td>
        <td th:text="${movie.title}"></td>
        <td><img th:src="${movie.thumbnail}" width="100"></td>
        <td th:text="${movie.description}"></td>
        <td>
          <ul>
            <li th:each="genre : ${movie.genres}" th:text="${genre.name}"></li>
          </ul>
        </td>
        <td th:text="${movie.releaseDate}"></td>
      </tr>
      </tbody>
    </table>

    <!-- 영화 페이지네이션 -->
    <div id="movies-pagination" class="pagination" th:if="${likedmovies.page.totalPages > 1}">
      <ul>
        <!-- 이전 페이지 링크: 1보다 클 때만 표시 -->
        <li th:if="${likedmovies.currentNumber() > 1}">
          <a href="#" th:attr="data-page=${likedmovies.currentNumber() - 2}, data-tab='movies'">«</a>
        </li>

        <!-- 페이지 번호 렌더링 -->
        <li th:each="i : ${#numbers.sequence(likedmovies.startNumber(), likedmovies.endNumber())}"
            th:classappend="${i == likedmovies.currentNumber} ? 'active'">
          <a href="#"
             th:attr="data-page=${i - 1}, data-tab='movies'"
             th:text="${i}"></a>
        </li>

        <!-- 다음 페이지 링크: 현재 페이지가 마지막 페이지보다 작을 때만 표시 -->
        <li th:if="${likedmovies.currentNumber < likedmovies.page.totalPages}">
          <a href="#" th:attr="data-page=${likedmovies.currentNumber}, data-tab='movies'">»</a>
        </li>
      </ul>
    </div>
  </div>

  <!-- 음악 탭 -->
  <div id="musics" class="like-item" th:if="${activeTab == 'musics'}">
    <h2>음악</h2>
    <table>
      <thead>
      <tr>
       <th>좋아요</th> <th>제목</th><th>썸네일</th><th>가수</th><th>장르</th><th>설명</th><th>가사</th><th>발매일</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="music : ${likedmusics.content()}">
        <td> <button class="toggle-star-btn"
                     th:id="'toggle-music-' + ${music.title}"
                     th:attr="data-type='music', data-id=${music.id}"
                     onclick="toggle(this)">
          ★
        </button> </td>
        <td th:text="${music.title}"></td>
        <td><img th:src="${music.thumbnail}" width="100"></td>
        <td th:text="${music.singer}"></td>
        <td th:text="${music.genre}"></td>
        <td th:text="${music.description}"></td>
        <td th:text="${music.lyrics}"></td>
        <td th:text="${music.releaseDate}"></td>
      </tr>
      </tbody>
    </table>

    <!-- 음악 페이지네이션 -->
    <div id="musics-pagination" class="pagination" th:if="${likedmusics.page.totalPages > 1}">
      <ul>
        <!-- 이전 페이지 링크: 1보다 클 때만 표시 -->
        <li th:if="${likedmusics.currentNumber() > 1}">
          <a href="#" th:attr="data-page=${likedmusics.currentNumber() - 2}, data-tab='musics'">«</a>
        </li>

        <!-- 페이지 번호 렌더링 -->
        <li th:each="i : ${#numbers.sequence(likedmusics.startNumber(), likedmusics.endNumber())}"
            th:classappend="${i == likedmusics.currentNumber} ? 'active'">
          <a href="#"
             th:attr="data-page=${i - 1}, data-tab='musics'"
             th:text="${i}"></a>
        </li>

        <!-- 다음 페이지 링크: 현재 페이지가 마지막 페이지보다 작을 때만 표시 -->
        <li th:if="${likedmusics.currentNumber < likedmusics.page.totalPages}">
          <a href="#" th:attr="data-page=${likedmusics.currentNumber}, data-tab='musics'">»</a>
        </li>
      </ul>
    </div>

  </div>

  <!-- 탭 스크립트 -->
  <script th:inline="javascript">
    /// 토글 버튼 구현
    function toggle(btn) {
    const type = btn.dataset.type;
    const id = btn.dataset.id;

    fetch(`/api/users/like/${type}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id})
  })
    .then(res => res.json())
    .then(data => {
    console.log("서버 응답",data);
    const isOn = data.status;

    // 텍스트는 항상 별로 고정
      btn.textContent = isOn ? '★' : '☆';
    btn.classList.toggle('on', isOn);


    // 동일 type, id를 가진 다른 버튼들 동기화
    const selector = `.toggle-star-btn[data-type='${type}'][data-id='${id}']`;
    document.querySelectorAll(selector).forEach(otherBtn => {
    if (otherBtn !== btn) {
      otherBtn.textContent = isOn ? '★' : '☆';
    otherBtn.classList.toggle('on',isOn);
  }
  });
  });

  }

    let currentPage = {
      books: /*[[${likedbooks.page.number}]]*/ 0,
      movies: /*[[${likedmovies.page.number}]]*/ 0,
      musics: /*[[${likedmusics.page.number}]]*/ 0
    };
    const pageSize = /*[[${likedbooks.page.size}]]*/ 3;

    function loadTab(tabName) {
      const tabItems = document.querySelectorAll('.like-item');
      tabItems.forEach(item => item.style.display = 'none');
      document.getElementById(tabName).style.display = 'block';
      updatePaginationLinks(tabName);
    }

    function updatePaginationLinks(tabName) {
      const paginationLinks = document.querySelectorAll(`#${tabName}-pagination a`);
      paginationLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const page = this.dataset.page;
          window.location.href = `/users/like?${tabName.slice(0, -1)}_page=${page}&size=${pageSize}&tab=${tabName}`;
        });
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const activeTab = /*[[${activeTab}]]*/ 'books';
      loadTab(activeTab);

      // 탭 버튼 이벤트 리스너
      document.querySelectorAll('.mypage-btn').forEach(button => {
        button.addEventListener('click', function() {
          const tab = this.textContent.toLowerCase();
          loadTab(tab);
        });
      });
    });
  </script>
</div>
</body>
</html>